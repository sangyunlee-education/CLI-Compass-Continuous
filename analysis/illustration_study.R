# ==============================================================================
# File: analysis/illustration_study.R
# Description: Empirical Analysis Example
# ==============================================================================

library(dplyr)
source("R/functions.R") # 함수 로드

# ------------------------------------------------------------------------------
# 1. 데이터 로드 및 전처리
# ------------------------------------------------------------------------------
# [주의] 원본 데이터(.sav)가 있다면 아래 주석을 해제하여 사용하세요.
# library(haven)
# x1 <- read_sav("Y5_SCH.sav"); x2 <- read_sav("Y6_SCH.sav")
# ... (데이터 병합 코드) ...
# df_proc <- ... (전처리 완료된 데이터)

# [공유용] 원본 데이터가 없는 사용자를 위한 '예시 데이터' 생성 (구조 동일)
# 실제 데이터 분석 시에는 이 부분을 주석 처리하고 위 코드를 쓰시면 됩니다.
set.seed(2026)
N_sample <- 300
x11 <- data.frame(
  A = rbinom(N_sample, 1, 0.5),      # 처치 변수 (진로집중과정 학교)
  P = rnorm(N_sample, 50, 10),       # 사전 국어 점수
  Y = rnorm(N_sample, 52, 10),       # 사후 국어 점수
  C1 = rnorm(N_sample, 50, 10),      # 탐지변수 1 (수학)
  C2 = rnorm(N_sample, 50, 10)       # 탐지변수 2 (영어)
)
# 실제 데이터가 있다면 x11 <- df_proc 형태로 덮어씌우면 됩니다.

# ------------------------------------------------------------------------------
# 2. 기본 분석 (Baseline Models)
# ------------------------------------------------------------------------------
cat("\n--- [1] ANCOVA Model ---\n")
print(summary(lm(Y ~ A + P, data = x11)))

cat("\n--- [2] Gain Score Model ---\n")
print(summary(lm(I(Y - P) ~ A, data = x11)))

# ------------------------------------------------------------------------------
# 3. aDID 분석 (Adjusted DID)
# ------------------------------------------------------------------------------
cat("\n--- [3] aDID Analysis (Using Control C1) ---\n")
adjusted_did_analytic(G = "A", Y = "Y", P = "P", C = "C1", x11)

cat("\n--- [3] aDID Analysis (Using Control C2) ---\n")
adjusted_did_analytic(G = "A", Y = "Y", P = "P", C = "C2", x11)

# ------------------------------------------------------------------------------
# 4. 탐지변수 가정 검정 (Tetrad Test)
# ------------------------------------------------------------------------------
cat("\n--- [4] Tetrad Assumption Test ---\n")
# 탐지변수(C1, C2)가 유효한지 검증
result <- test_tetrad_assumption(
  data = x11,
  outcome = "Y", pre = "P", detect1 = "C1", detect2 = "C2", group = "A"
)

print(result)